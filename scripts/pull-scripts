#!/bin/bash
set -e # Exit immediately if a command exits with a non-zero status.

cd $(dirname $0) # Move to the directory of the script
source ./version # Source the version file to set environment variables

CACHE_FILE="../bin/.version-check-cache"
CACHE_MAX_AGE=86400 # 24 hours in seconds

# Function to fetch the latest version from GitHub
fetch_latest_version() {
    curl --silent "https://api.github.com/repos/rancher/charts-build-scripts/releases/latest" | jq -r '.tag_name'
}

# Function to get the latest version with caching
get_latest_version() {
    local now=$(date +%s)
    local cache_valid=false

    # Check if cache exists and is recent
    if [[ -f "$CACHE_FILE" ]]; then
        local cache_time=$(head -n 1 "$CACHE_FILE")
        local cache_age=$((now - cache_time))

        if [[ $cache_age -lt $CACHE_MAX_AGE ]]; then
            cache_valid=true
        fi
    fi

    # Use cache or fetch new version
    if [[ "$cache_valid" == "true" ]]; then
        tail -n 1 "$CACHE_FILE"
    else
        local latest=$(fetch_latest_version)
        # Update cache
        mkdir -p "$(dirname "$CACHE_FILE")"
        echo "$now" > "$CACHE_FILE"
        echo "$latest" >> "$CACHE_FILE"
        echo "$latest"
    fi
}

# Check if the charts-build-scripts binary exists in the ../bin directory
echo "Check if charts-build-scripts binary is present on the target version"
if ls ../bin/charts-build-scripts 1>/dev/null 2>/dev/null; then
    CURRENT_SCRIPT_VERSION="v$(../bin/charts-build-scripts --version | awk '{print $3}')"
    echo "Current version: ${CURRENT_SCRIPT_VERSION}"
    echo "Expected version: ${CHARTS_BUILD_SCRIPT_VERSION}"

    # If the version is "latest", resolve it using cached check
    if [[ "${CHARTS_BUILD_SCRIPT_VERSION}" == "latest" ]]; then
        CHARTS_BUILD_SCRIPT_VERSION=$(get_latest_version)
        echo "Resolved latest version to ${CHARTS_BUILD_SCRIPT_VERSION}"
    fi

    # Check if current version matches expected version
    if [[ "${CURRENT_SCRIPT_VERSION}" == "${CHARTS_BUILD_SCRIPT_VERSION}" ]]; then
        echo "target version already present"

        # Warn if a newer version is available (only when using a pinned version)
        if [[ "${CHARTS_BUILD_SCRIPT_VERSION}" != "latest" ]]; then
            LATEST_AVAILABLE=$(get_latest_version)
            if [[ "${CURRENT_SCRIPT_VERSION}" != "${LATEST_AVAILABLE}" ]]; then
                echo "⚠️  Warning: A newer version is available: ${LATEST_AVAILABLE}"
                echo "   Current version: ${CURRENT_SCRIPT_VERSION}"
                echo "   To upgrade, update CHARTS_BUILD_SCRIPT_VERSION in scripts/version or set to 'latest'"
            fi
        fi

        exit 0
    fi
fi

# If the version is "latest", resolve it using cached check
if [[ "${CHARTS_BUILD_SCRIPT_VERSION}" == "latest" ]]; then
    echo "Expected the latest version!"
    CHARTS_BUILD_SCRIPT_VERSION=$(get_latest_version)
    echo "Resolved latest version to ${CHARTS_BUILD_SCRIPT_VERSION}"
fi

echo "Downloading charts-build-scripts version ${CHARTS_BUILD_SCRIPTS_REPO}@${CHARTS_BUILD_SCRIPT_VERSION}"

# Remove existing bin/charts-build-scripts
echo "remove existing ../bin/charts-build-scripts"
rm -f ../bin/charts-build-scripts
cd ..
echo "Validating/Securing bin directory"
mkdir -p bin # Ensure existence (creates if missing)
chmod -R a+x bin/ # Ensure it's executable

# Extract the OS and architecture from the go version command output
OS=$(go version | cut -d' ' -f4 | cut -d'/' -f1)
ARCH=$(go version | cut -d' ' -f4 | cut -d'/' -f2)
echo "OS: $OS"
echo "ARCH: $ARCH"

# Determine the binary name based on the OS and architecture
if [[ "$OS" == "windows" ]]; then
    BINARY_NAME="charts-build-scripts_${OS}_${ARCH}.exe"
else
    BINARY_NAME="charts-build-scripts_${OS}_${ARCH}"
fi
echo "BINARY_NAME: $BINARY_NAME"

# Download the binary from the charts-build-scripts repository
echo "Downloading ${CHARTS_BUILD_SCRIPTS_REPO%.git}/releases/download/${CHARTS_BUILD_SCRIPT_VERSION}/${BINARY_NAME}"
curl_output=$(curl -s -L -w "%{http_code}" ${CHARTS_BUILD_SCRIPTS_REPO%.git}/releases/download/${CHARTS_BUILD_SCRIPT_VERSION}/${BINARY_NAME} --output bin/charts-build-scripts)
HTTP_CODE=$(echo "$curl_output" | tail -n 1) # Extract the HTTP code from the last line
if [[ "$HTTP_CODE" -ne 200 ]]; then
    echo "Error downloading ${BINARY_NAME}, HTTP code: $HTTP_CODE"
    exit 1
fi
echo "Downloaded ${BINARY_NAME} to ./bin/charts-build-scripts"

echo "Checking downloaded binary file"
file bin/charts-build-scripts

file bin/charts-build-scripts #check the file type.
echo "${BINARY_NAME} => ./bin/charts-build-scripts"

chmod +x ./bin/charts-build-scripts
./bin/charts-build-scripts --version
